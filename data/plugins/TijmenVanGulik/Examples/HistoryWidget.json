{"id":"tijmenvangulik_examples_historywidget","name":"Examples history widget","description":"Example how to write a history widget","version":"1.0","author":"Tijmen van Gulik","url":"plugins/TijmenVanGulik/Examples/HistoryWidget.json","script":"var __extends = (this && this.__extends) || function (d, b) {\r\n    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\r\n    function __() { this.constructor = d; }\r\n    __.prototype = b.prototype;\r\n    d.prototype = new __();\r\n};\r\nvar tijmenvangulik_examples_historywidget;\r\n(function (tijmenvangulik_examples_historywidget) {\r\n    var HistoryXasOptions = (function () {\r\n        function HistoryXasOptions() {\r\n        }\r\n        HistoryXasOptions.getFromId = function (id) {\r\n            switch (id) {\r\n                case \"historyExampleTime\": return HistoryXasOptions.workTime;\r\n                case \"historyExampleMeters\": return HistoryXasOptions.workDistance;\r\n                default: return HistoryXasOptions.workTime;\r\n            }\r\n            return HistoryXasOptions.workTime;\r\n        };\r\n        HistoryXasOptions.workTime = { value: \"workTime\", controlId: \"historyExampleExampleTime\", chartAxisType: \"datetime\", caption: \"Work time\" };\r\n        HistoryXasOptions.workDistance = { value: \"workDistance\", controlId: \"historyExampleExampleMeters\", chartAxisType: \"linear\", caption: \"Work distance\" };\r\n        return HistoryXasOptions;\r\n    })();\r\n    var HistoryYasOptions = (function () {\r\n        function HistoryYasOptions() {\r\n        }\r\n        HistoryYasOptions.getFromId = function (id) {\r\n            switch (id) {\r\n                case \"historyExampleSplit\": return HistoryYasOptions.split;\r\n                case \"historyExamplePower\": return HistoryYasOptions.power;\r\n                case \"historyExampleStrokesPerMinute\": return HistoryYasOptions.strokesPerMinute;\r\n                default: return HistoryYasOptions.split;\r\n            }\r\n            return HistoryYasOptions.split;\r\n        };\r\n        HistoryYasOptions.split = { value: \"splitTime\", controlId: \"historyExampleSplit\", chartAxisType: \"datetime\", caption: \"Split time\" };\r\n        HistoryYasOptions.power = { value: \"power\", controlId: \"historyExamplePower\", chartAxisType: \"linear\", caption: \"Power\" };\r\n        HistoryYasOptions.strokesPerMinute = { value: \"strokesPerMinute\", controlId: \"historyExampleStrokesPerMinute\", chartAxisType: \"linear\", caption: \"Strokes per minute\" };\r\n        return HistoryYasOptions;\r\n    })();\r\n    /*------------------------------------------------------------------------------\r\n        Stroke history widget example\r\n    ------------------------------------------------------------------------------*/\r\n    var ExampleHistoryChartWidget = (function (_super) {\r\n        __extends(ExampleHistoryChartWidget, _super);\r\n        function ExampleHistoryChartWidget(controller) {\r\n            _super.call(this, controller);\r\n            this._historyXasOption = HistoryXasOptions.workTime;\r\n            this._historyYasOption = HistoryYasOptions.split;\r\n            this.caption = \"Example history chart\";\r\n            this.editPropertiesVisible = true;\r\n            this.defaultWidth = 2;\r\n            //init the dialog\r\n            var widget = this;\r\n            $('#dialogHistoryExampleSettings').dialog({\r\n                width: 500,\r\n                autoOpen: false,\r\n                modal: true,\r\n                buttons: {\r\n                    \"Close\": function () {\r\n                        widget.setOptions();\r\n                        widget.reCreateChart();\r\n                        widget.updateChart();\r\n                        $(this).dialog(\"close\");\r\n                    },\r\n                    \"Clear data\": function () {\r\n                        widget.setOptions();\r\n                        pm3.monitor.clearHistory();\r\n                        widget.reCreateChart();\r\n                        widget.updateChart();\r\n                        $(this).dialog(\"close\");\r\n                    },\r\n                    \"Export\": function () {\r\n                        widget.exportData();\r\n                    }\r\n                }\r\n            });\r\n        }\r\n        ExampleHistoryChartWidget.prototype.getChartOptions = function () {\r\n            Highcharts.setOptions({\r\n                global: {\r\n                    useUTC: true\r\n                }\r\n            });\r\n            var chartWidget = this;\r\n            return {\r\n                chart: {\r\n                    renderTo: 'container',\r\n                    type: 'area'\r\n                },\r\n                title: null,\r\n                xAxis: {\r\n                    type: this._historyXasOption.chartAxisType,\r\n                    title: {\r\n                        text: this._historyXasOption.caption\r\n                    },\r\n                    showFirstLabel: false\r\n                },\r\n                yAxis: {\r\n                    title: {\r\n                        text: this._historyYasOption.caption\r\n                    },\r\n                    type: this._historyYasOption.chartAxisType\r\n                },\r\n                plotOptions: {\r\n                    area: {\r\n                        marker: {\r\n                            enabled: false,\r\n                            states: {\r\n                                hover: {\r\n                                    enabled: true,\r\n                                    radius: 5\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                },\r\n                tooltip: {\r\n                    formatter: function () {\r\n                        var x = this.x;\r\n                        if (chartWidget._historyXasOption.chartAxisType == 'datetime')\r\n                            x = Highcharts.dateFormat('%H:%M:%S', x);\r\n                        var y = this.y;\r\n                        if (chartWidget._historyYasOption.chartAxisType == 'datetime')\r\n                            y = Highcharts.dateFormat('%M:%S', y);\r\n                        return '<b>' + this.series.name + '</b><br/>' +\r\n                            chartWidget._historyXasOption.caption + ':' + x + '<br/>' +\r\n                            chartWidget._historyYasOption.caption + ':' + y;\r\n                    }\r\n                },\r\n                legend: {\r\n                    enabled: false\r\n                },\r\n                exporting: {\r\n                    enabled: true\r\n                },\r\n                series: [{\r\n                        name: 'History data',\r\n                        data: []\r\n                    }]\r\n            };\r\n        };\r\n        ExampleHistoryChartWidget.prototype.initControl = function () {\r\n            _super.prototype.initControl.call(this);\r\n        };\r\n        ExampleHistoryChartWidget.prototype.exportData = function () {\r\n            if (pm3.monitor.historyCount > 0) {\r\n                var exportData = [];\r\n                for (var i = 0; i < pm3.monitor.historyCount; i++) {\r\n                    var c = pm3.monitor.getHistory(i);\r\n                    exportData.push({ \"workTime\": utilities.formatRelativeTime(c.workTime),\r\n                        \"power\": c.power,\r\n                        \"strokesPerMinute\": c.strokesPerMinute,\r\n                        \"workDistance\": c.workDistance,\r\n                        \"splitTime\": utilities.formatRelativeTime(c.splitTime)\r\n                    });\r\n                }\r\n                var blob = new Blob([JSON.stringify(exportData)], { type: \"data:application/json;charset=utf-8\" });\r\n                saveAs(blob, \"History.JSON\");\r\n            }\r\n            else\r\n                app.showTopError(\"No data to export.\");\r\n        };\r\n        ExampleHistoryChartWidget.prototype.setOptions = function () {\r\n            var checkedControlIdX = $('input[name=radioHistoryExampleXAxis]:checked').prop('id');\r\n            this._historyXasOption = HistoryXasOptions.getFromId(checkedControlIdX);\r\n            var checkedControlIdY = $('input[name=radioHistoryExampleYAxis]:checked').prop('id');\r\n            this._historyYasOption = HistoryYasOptions.getFromId(checkedControlIdY);\r\n        };\r\n        ExampleHistoryChartWidget.prototype.openEditProperties = function () {\r\n            $('#' + this._historyXasOption.controlId).attr('checked', true);\r\n            $('#historyExampleXAxis').buttonset();\r\n            $('#' + this._historyYasOption.controlId).attr('checked', true);\r\n            $('#historyExampleYAxis').buttonset();\r\n            $('#dialogHistoryExampleSettings').dialog('open');\r\n        };\r\n        ExampleHistoryChartWidget.prototype.updateChart = function () {\r\n            var count = pm3.monitor.historyCount;\r\n            var series = this.chart.series[0];\r\n            var countPoints = series.points.length;\r\n            var clear = false;\r\n            if (count > countPoints) {\r\n                for (var i = countPoints; i < count; i++) {\r\n                    var last = (i == (count - 1));\r\n                    var yValue = pm3.monitor.getHistory(i)[this._historyYasOption.value];\r\n                    var xValue = pm3.monitor.getHistory(i)[this._historyXasOption.value];\r\n                    if (i > 0) {\r\n                        var xPrevValue = pm3.monitor.getHistory(i - 1)[this._historyXasOption.value];\r\n                        if (xPrevValue > xValue)\r\n                            clear = true;\r\n                    }\r\n                    if (xValue instanceof Date)\r\n                        xValue = xValue.getTime(); //date.getTime()+\r\n                    if (yValue instanceof Date)\r\n                        yValue = yValue.getTime(); //date.getTime()+\r\n                    series.addPoint([xValue, yValue], last, false);\r\n                }\r\n            }\r\n            else if (count < countPoints)\r\n                clear = true;\r\n            if (clear) {\r\n                pm3.monitor.clearHistory();\r\n                this.reCreateChart();\r\n            }\r\n        };\r\n        ExampleHistoryChartWidget.prototype.historyUpdate = function (count) {\r\n            this.updateChart();\r\n        };\r\n        ExampleHistoryChartWidget.prototype.loaded = function () {\r\n            _super.prototype.loaded.call(this);\r\n            pm3.monitor.pubsubs.subHistoryUpdate(this, this.historyUpdate);\r\n        };\r\n        ExampleHistoryChartWidget.prototype.beforeUnload = function () {\r\n            _super.prototype.beforeUnload.call(this);\r\n            pm3.monitor.pubsubs.unsubHistoryUpdate(this.historyUpdate);\r\n        };\r\n        return ExampleHistoryChartWidget;\r\n    })(ergometerWidgets.HighChartWidget);\r\n    /*------------------------------------------------------------------------------\r\n        Create and remove the widgets in the Plugin\r\n    ------------------------------------------------------------------------------*/\r\n    var ExamplePlugin = (function (_super) {\r\n        __extends(ExamplePlugin, _super);\r\n        function ExamplePlugin() {\r\n            _super.apply(this, arguments);\r\n        }\r\n        ExamplePlugin.prototype.init = function () {\r\n            //create the widget(s) on create\r\n            dashboard.widgetRegistry().register(ExampleHistoryChartWidget, 'tijmenvangulik_examples_HistoryWidget', 'History chart', ['Examples']);\r\n        };\r\n        ExamplePlugin.prototype.remove = function () {\r\n            //remove the widgets when the plugin is removed\r\n            dashboard.widgetRegistry().deregister('tijmenvangulik_examples_HistoryWidget');\r\n        };\r\n        return ExamplePlugin;\r\n    })(ExternalPlugin);\r\n    var plugin;\r\n    plugin = new ExamplePlugin();\r\n})(tijmenvangulik_examples_historywidget || (tijmenvangulik_examples_historywidget = {}));\r\n","styles":"\n","typeScript":"module tijmenvangulik_examples_historywidget { //make a name space to prevent mix ups\n\n\texport interface HistoryXasOption {\n\t\tvalue : string;\n\t\tcontrolId : string;\n\t\tchartAxisType : string;\n\t\tcaption : string;\n\t}\n\t\n\texport interface HistoryYasOption {\n\t\tvalue :string;\n\t\tcontrolId : string;\n\t\tchartAxisType : string;\n\t\tcaption : string;\n\t}\n\n\tclass HistoryXasOptions{ \n\t    public static workTime : HistoryXasOption = {value : \"workTime\", controlId :\"historyExampleExampleTime\",chartAxisType:\"datetime\", caption:\"Work time\" };\n\t    public static workDistance : HistoryXasOption = {value :\"workDistance\" , controlId :\"historyExampleExampleMeters\",chartAxisType:\"linear\",caption:\"Work distance\" };\n\t    public static getFromId(id : string) : HistoryXasOption {\n\t\t\tswitch (id) //should learn too loop items in class\n\t\t\t{\n\t\t\t\tcase \"historyExampleTime\" : return HistoryXasOptions.workTime;\n\t\t\t\tcase \"historyExampleMeters\" : return HistoryXasOptions.workDistance;\n\t\t\t\tdefault : return HistoryXasOptions.workTime;\n\t\t\t}\n\t\t\treturn HistoryXasOptions.workTime;\n\t    }\n\t}\n\n    class HistoryYasOptions{\n\t    public static split : HistoryYasOption= {value :\"splitTime\", controlId :\"historyExampleSplit\",chartAxisType:\"datetime\", caption:\"Split time\" };\n\t    public static power : HistoryYasOption= {value :\"power\", controlId :\"historyExamplePower\",chartAxisType:\"linear\", caption:\"Power\" };\n\t    public static strokesPerMinute : HistoryYasOption= {value :\"strokesPerMinute\", controlId :\"historyExampleStrokesPerMinute\",chartAxisType:\"linear\", caption:\"Strokes per minute\"};\n\t    public static getFromId(id : string) : HistoryXasOption {\n\t\t\tswitch (id) //should learn too loop items in class\n\t\t\t{\n\t\t\t\tcase \"historyExampleSplit\" : return HistoryYasOptions.split;\n\t\t\t\tcase \"historyExamplePower\" : return HistoryYasOptions.power;\n\t\t\t\tcase \"historyExampleStrokesPerMinute\" : return HistoryYasOptions.strokesPerMinute;\n\t\t\t\tdefault : return HistoryYasOptions.split;\n\t\t\t}\n\t\t\treturn HistoryYasOptions.split;\n\t    }\n\t\t\n\t}\n\n/*------------------------------------------------------------------------------\n    Stroke history widget example\n------------------------------------------------------------------------------*/\n    class ExampleHistoryChartWidget  extends ergometerWidgets.HighChartWidget {\n\n\t\tprivate _historyXasOption : HistoryXasOption = HistoryXasOptions.workTime;\n\t\tprivate _historyYasOption : HistoryYasOption = HistoryYasOptions.split;\n\t\t\n\t\tpublic getChartOptions() : HighchartsOptions {\n\t\t\tHighcharts.setOptions({\n            \tglobal: {\n                \tuseUTC: true\n            \t}\n        \t});\n        \tvar chartWidget =this;\n\t\t\treturn {\n\t            chart: {\n\t                renderTo: 'container',\n\t                type: 'area'\n\t            },\n\t            title: null,\n\t            xAxis: {\n\t                type: this._historyXasOption.chartAxisType,\n\t                title: {\n\t                    text: this._historyXasOption.caption\n\t                },\n\t                showFirstLabel: false\n\n\t            },\n\t            yAxis: {\n\t                title: {\n\t                    text: this._historyYasOption.caption\n\t                },\n\t                type: this._historyYasOption.chartAxisType\t                \n\t            },\n\t            plotOptions: { \n\t            \tarea: {\n\t\t            \tmarker: {\n\t                        enabled: false,\n\t                        states: {\n\t                            hover: {\n\t                                enabled: true,\n\t                                radius: 5\n\t                            }\n\t                        }\n\t                    }\n\t            \t}\n\t            \t\n\t            },\n\t            tooltip: {\n\t                formatter: function() { //need mixed scope here\n\t                        var x : any=this.x;\n\t                        if (chartWidget._historyXasOption.chartAxisType=='datetime') \n\t                          x=Highcharts.dateFormat('%H:%M:%S', x);\n\t\t\t\t\t\t\tvar y: any=this.y;\n\t                        if (chartWidget._historyYasOption.chartAxisType=='datetime') \n\t                          y=Highcharts.dateFormat('%M:%S', y) \n\t                        return '<b>'+ this.series.name +'</b><br/>'+\n\t                        \t    chartWidget._historyXasOption.caption+':'+x+'<br/>'+\n\t                        \t\tchartWidget._historyYasOption.caption+':'+y;\n\t                }\n\t            },\n\t            legend: {\n\t                enabled: false\n\t            },\n\t            exporting: {\n\t                enabled: true\n\t            },\n\t            series: [{\n\t                name: 'History data',\n\t                data: [ ]\n\t            }]\n\t            \n\t        };\n\t\t}\n        public initControl() {\n            super.initControl();\n\t\t}\n\t\tpublic exportData() {\n\t\t\tif (pm3.monitor.historyCount>0) {\n\t\t\t\tlet exportData = [];\n\t\t\t\tfor(let i =0; i<pm3.monitor.historyCount;i++ ) {\n\t\t\t\t\tlet c=pm3.monitor.getHistory(i);\n\t\t\t\t\texportData.push(\n\t\t\t\t\t\t\t{ \"workTime\": utilities.formatRelativeTime(c.workTime),\n\t\t\t\t\t\t\t\t\"power\": c.power,\n\t\t\t\t\t\t\t\t\"strokesPerMinute\":c.strokesPerMinute ,\n\t\t\t\t\t\t\t\t\"workDistance\":c.workDistance,\n\t\t\t\t\t\t\t\t\"splitTime\":utilities.formatRelativeTime(c.splitTime)\n\t\t\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t\tlet blob = new Blob([JSON.stringify(exportData)], {type: \"data:application/json;charset=utf-8\"});\n\n\t\t\t\tsaveAs(blob, \"History.JSON\");\n\t\t\t}\n\t\t\telse app.showTopError(\"No data to export.\")\n\t\t}\n\t\tconstructor (controller : dashboard.Controller) {\n\t\t\tsuper(controller);\n\t\t\tthis.caption = \"Example history chart\";\n\t\t\tthis.editPropertiesVisible = true;\n\t\t\tthis.defaultWidth=2;\n\t\t\t//init the dialog\n\t\t\tvar widget = this;\n\t\t\t$('#dialogHistoryExampleSettings').dialog({\n\t\t        width: 500, //can not come from the style\n\t\t        autoOpen: false,\n\t\t        modal: true,\n\t\t        buttons: {\n\t\t            \"Close\": function () {\n\t\t            \twidget.setOptions();\n\t\t            \twidget.reCreateChart();\n\t\t            \twidget.updateChart();\n\t\t                $(this).dialog(\"close\");\n\t\t            },\n\t\t            \"Clear data\": function ()  {\n\t\t            \twidget.setOptions();\n\t\t            \tpm3.monitor.clearHistory();\n\t\t            \twidget.reCreateChart();\n\t\t            \twidget.updateChart();\n\t\t                $(this).dialog(\"close\");\n\t\t            },\n\t\t\t\t\t\"Export\": function ()  {\n\t\t\t\t\t\twidget.exportData();\n\t\t\t\t\t}\n\t\t        }\n\t\t    });\n\t\t    \n\t\t}\n\n\t\tpublic setOptions() {\n\t\t\t\n\t\t\tvar checkedControlIdX = $('input[name=radioHistoryExampleXAxis]:checked').prop('id');\n\t\t\tthis._historyXasOption = HistoryXasOptions.getFromId(checkedControlIdX);\n\n\t\t\tvar checkedControlIdY = $('input[name=radioHistoryExampleYAxis]:checked').prop('id');\n\t\t\tthis._historyYasOption = HistoryYasOptions.getFromId(checkedControlIdY);\n\t\t\t\n\t\t}\n\t\tpublic openEditProperties() {\n\t\t\t$('#'+this._historyXasOption.controlId).attr('checked',true);\n\t\t\t$('#historyExampleXAxis').buttonset();\n\n\t\t\t$('#'+this._historyYasOption.controlId).attr('checked',true);\n      \t\t$('#historyExampleYAxis').buttonset();\n\n\t\t\t$('#dialogHistoryExampleSettings').dialog('open');\n\n\t\t}\n\n\t\tpublic updateChart() {\n\n\t\t\tvar count : number= pm3.monitor.historyCount;\n\t\t\tvar series = this.chart.series[0];\n\t\t\tvar countPoints  = series.points.length;\n\t\t\tvar clear = false;\n\t\t\t\n\t\t\tif (count>countPoints) {\t\t\n\n\t\t\t\tfor (var i=countPoints;i<count;i++) {\n\t\t\t\t\tvar last = (i==(count-1));\n\t\t\t\t\tvar yValue = pm3.monitor.getHistory(i)[this._historyYasOption.value];\n\n\t\t\t\t\tvar xValue = pm3.monitor.getHistory(i)[this._historyXasOption.value];\n\t\t\t\t\tif (i>0) {\n\t\t\t\t\t\tvar xPrevValue = pm3.monitor.getHistory(i-1)[this._historyXasOption.value];\n\t\t\t\t\t\tif (xPrevValue>xValue) //when time or meters go backwards, do a clear\n\t\t\t\t\t\t  clear= true; \n\t\t\t\t\t}\n\t\t          \tif (xValue instanceof Date )\n\t\t        \t   xValue = xValue.getTime();  //date.getTime()+\n\t\t        \tif (yValue instanceof Date )\n\t\t        \t   yValue = yValue.getTime();\t//date.getTime()+\n\n\t\t\t\t\tseries.addPoint([xValue, yValue], last ,false);\n\t\t\t\t}\n\t        \t\t\n\t\t\t}\n\t\t\telse if (count<countPoints) clear=true;\n\t\t\t\n\t\t\tif (clear) {\n\t\t\t\tpm3.monitor.clearHistory();\n\t\t\t\tthis.reCreateChart();\n\t\t\t}\n\n\t\t}\n\t\tpublic historyUpdate(count : number) {\n\t        this.updateChart();\n \t\t}\n\n \t\tpublic loaded() {\n          super.loaded();\n          pm3.monitor.pubsubs.subHistoryUpdate(this, this.historyUpdate);\n        }\n        public beforeUnload() {\n          super.beforeUnload();\n          pm3.monitor.pubsubs.unsubHistoryUpdate( this.historyUpdate);\n        }\n \t\t\t\n\t}\n\n/*------------------------------------------------------------------------------\n    Create and remove the widgets in the Plugin\n------------------------------------------------------------------------------*/\n    class ExamplePlugin extends ExternalPlugin {\n        \n        public historyWidget : ExampleHistoryChartWidget;\n        \n        public init() {\n            //create the widget(s) on create\n            dashboard.widgetRegistry().register(ExampleHistoryChartWidget,'tijmenvangulik_examples_HistoryWidget','History chart',['Examples']);\n        }\n        public remove() {\n            //remove the widgets when the plugin is removed\n            dashboard.widgetRegistry().deregister('tijmenvangulik_examples_HistoryWidget');\n        }               \n    }\n\n    var plugin : ExamplePlugin;\n    plugin = new ExamplePlugin();\n    \n}\n\n\n    ","html":"<div id=\"dialogHistoryExampleSettings\" title=\"Example history settings\" >\n    <div class=\"form-horizontal\">\n        <div class=\"control-group\">\n            <label class=\"control-label\" for=\"historyExampleXAxis\">X-axis</label>\n            <div class=\"controls\">\n                <div id=\"historyExampleXAxis\">\n                    <input type=\"radio\" id=\"historyExampleTime\" name=\"radioHistoryExampleXAxis\" /><label for=\"historyExampleTime\">Time</label>\n                    <input type=\"radio\" id=\"historyExampleMeters\" name=\"radioHistoryExampleXAxis\" /><label for=\"historyExampleMeters\">Meters</label>\n                </div>\n            </div>\n        </div>\n        <div class=\"control-group\">\n            <label class=\"control-label\" for=\"historyExampleYAxis\">Y-axis</label>\n            <div class=\"controls\">\n                <div id=\"historyExampleYAxis\">\n                    <input type=\"radio\" id=\"historyExampleSplit\" name=\"radioHistoryExampleYAxis\" /><label for=\"historyExampleSplit\">Split</label>\n                    <input type=\"radio\" id=\"historyExamplePower\" name=\"radioHistoryExampleYAxis\" /><label for=\"historyExamplePower\">Power</label>\n                    <input type=\"radio\" id=\"historyExampleStrokesPerMinute\" name=\"radioHistoryExampleYAxis\" /><label for=\"historyExampleStrokesPerMinute\">Strokes per min</label>\n                </div>\n            </div>\n        </div>\n    </div>\n\n</div>\n"}